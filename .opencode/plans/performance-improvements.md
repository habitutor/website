# Performance Improvement Plan

## Overview

Analysis of API and DB layers identified 8 performance issues. This plan tracks implementation progress.

---

## Priority 1: Database Indexes

**Status:** ✅ Complete (Schema updated, migration generated)
**Risk:** Low
**Impact:** High

### Schema Files Modified

#### `packages/db/src/schema/practice-pack.ts`

| Index | Table | Columns | Reason |
|-------|-------|---------|--------|
| `idx_pp_attempt_user` | `practice_pack_attempt` | `user_id` | Filter by user in list/history |
| `idx_pp_attempt_pack` | `practice_pack_attempt` | `practice_pack_id` | Join with pack |
| `idx_pp_user_answer_attempt` | `practice_pack_user_answer` | `attempt_id` | Join queries |
| `idx_question_flashcard` | `question` | `is_flashcard_question` | Filter flashcard questions |
| `idx_answer_option_question` | `question_answer_option` | `question_id` | Join for answers |

#### `packages/db/src/schema/flashcard.ts`

| Index | Table | Columns | Reason |
|-------|-------|---------|--------|
| `idx_flashcard_attempt_user` | `user_flashcard_attempt` | `user_id` | Filter by user |
| `idx_flashcard_attempt_user_started` | `user_flashcard_attempt` | `user_id, started_at` | Get latest attempt |
| `idx_flashcard_answer_attempt` | `user_flashcard_question_answer` | `attempt_id` | Join queries |

#### `packages/db/src/schema/transaction.ts`

| Index | Table | Columns | Reason |
|-------|-------|---------|--------|
| `idx_transaction_user` | `transaction` | `user_id` | User transaction lookup |

### Migration Generated

`packages/db/src/migrations/0005_unusual_overlord.sql` - 9 indexes created

---

## Priority 2: Replace ORDER BY RANDOM()

**Status:** ✅ Complete
**Risk:** Medium
**Impact:** High
**Location:** `packages/api/src/routers/flashcard.ts`

### Implementation

Changed from single query with full table scan to two-query approach:

1. Select 5 random IDs only (uses `idx_question_flashcard` index)
2. Fetch full question data with relations by ID

This avoids scanning all question rows and their relations when randomizing.

---

## Priority 3: Query Consolidation

**Status:** ✅ Complete
**Risk:** Medium
**Impact:** Medium

### trackView Refactor

Refactored from 5+ queries to a single raw SQL query with CTEs:
- DELETE existing view for this user/subtest
- INSERT new view record
- DELETE old views using window function (keep only 10 most recent per user/subtest)

### getRecentViews Refactor

Refactored from 2 queries + in-memory processing to single SQL query with DISTINCT ON subquery for efficient deduplication

---

## Priority 4: Connection Pooling

**Status:** ✅ Complete
**Risk:** Low
**Impact:** High

### Implementation

Added pg Pool configuration with:
- `max: 20` - connection pool size
- `idleTimeoutMillis: 30000` - 30 seconds idle timeout
- `connectionTimeoutMillis: 10000` - 10 seconds connection timeout
- Properly configured SSL for production vs development environments

---

## Priority 5: Add Pagination

**Status:** ✅ Complete
**Risk:** Low
**Impact:** Medium

### Implementation

- `/practice-packs/history` - Added limit (default 20, max 100) and offset parameters
- `/subtests` - Added limit (default 50, max 100) and offset parameters, returns `{ data, limit, offset }`

---

## Priority 6: Remove Unnecessary Transactions

**Status:** ✅ Complete
**Risk:** Low
**Impact:** Low

### Implementation

Removed transaction wrapper from flashcard save handler - single-table operations don't need atomicity guarantees from transactions

---

## Implementation Checklist

- [x] Add indexes to `packages/db/src/schema/practice-pack.ts`
- [x] Add indexes to `packages/db/src/schema/flashcard.ts`
- [x] Add indexes to `packages/db/src/schema/transaction.ts`
- [x] Generate and review migration (`bun db:generate`)
- [ ] Run migration (`bun db:migrate`) - **Requires manual review and execution**
- [x] Replace `ORDER BY RANDOM()` in `packages/api/src/routers/flashcard.ts`
- [x] Refactor trackView and getRecentViews queries
- [x] Add connection pooling configuration
- [x] Add pagination to unbounded queries
- [x] Remove unnecessary transaction in flashcard save
- [ ] Test flashcard start endpoint

---

## Notes

- Auth schema (`auth.ts`) is auto-generated by better-auth and should not be modified
- Indexes on auth tables are already in place (session_userId_idx, account_userId_idx)
- Migration file generated: `0005_unusual_overlord.sql`
